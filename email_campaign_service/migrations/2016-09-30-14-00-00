"""
Add EmailConversations table
"""

from sqlalchemy import text

from email_campaign_service.common.models.db import db
from email_campaign_service.common.models.email_campaign import EmailConversations

table_name = EmailConversations.__tablename__
query = "select * from information_schema.tables where table_name = '{}'".format(table_name)
result = db.session.execute(query)
tables = list(result)
if len(tables) == 0:
    db.session.execute(
        text("CREATE TABLE `{}` (`id` INT(11) NOT NULL AUTO_INCREMENT,\
                                 `user_id` BIGINT(20) NOT NULL,\
                                 `candidate_id` BIGINT(20) NOT NULL,\
                                 `mailbox` VARCHAR(10) NOT NULL,\
                                 `subject` VARCHAR(100) NOT NULL,\
                                 `body` VARCHAR(1000) DEFAULT NULL,\
                                 `email_received_datetime` TIMESTAMP NOT NULL,\
                                 `updated_datetime` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\
                                 PRIMARY KEY (`id`), KEY `email_conversations_ibfk_1` (`user_id`), CONSTRAINT `email_conversations_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `user` (`Id`) ON DELETE CASCADE,\
                                 KEY `email_conversations_ibfk_2` (`candidate_id`), CONSTRAINT `email_conversations_ibfk_2` FOREIGN KEY (`candidate_id`) REFERENCES `candidate` (`Id`) ON DELETE CASCADE) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='utf8_general_ci'".format(table_name))
        )
