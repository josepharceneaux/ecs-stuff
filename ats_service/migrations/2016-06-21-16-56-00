"""
Add ATS table.
"""

from sqlalchemy import text

from ats_service.app import db
from ats_service.common.models.ats import ATS, ATSAccount, ATSCredential, ATSCandidate, ATSCandidateProfile
from ats_service.common.models.user import User


if ATS.__tablename__ not in db.engine.table_names():
    db.session.execute(
        text("create table `ats` ( \
                                   `id` bigint auto_increment key, \
                                   `name` varchar(255) not null, \
                                   `homepage_url` varchar(255) not null, \
                                   `login_url` varchar(255), \
                                   `auth_type` varchar(45) not null, \
                                   `added_at` timestamp not null, \
                                   `updated_at` timestamp not null \
                                 )")
        )

if ATSAccount.__tablename__ not in db.engine.table_names():
    db.session.execute(
        text("create table `ats_account` ( \
                                          `id` bigint auto_increment key, \
                                          `active` BOOLEAN, \
                                          `ats_id` bigint, \
                                          `user_id` bigint, \
                                          `ats_credential_id` bigint, \
                                          `added_at` timestamp not null, \
                                          `updated_at` timestamp not null \
                                         )")
        )

if ATSCredential.__tablename__ not in db.engine.table_names():
    db.session.execute(
        text("create table `ats_credential` ( \
                                             `id` bigint auto_increment key, \
                                             `ats_account_id` bigint, \
                                             `auth_type` varchar(45) not null, \
                                             `credentials_json` text not null, \
                                             `updated_at` timestamp not null \
                                            )")
        )

if ATSCandidate.__tablename__ not in db.engine.table_names():
    db.session.execute(
        text("create table `ats_candidate` ( \
                                            `id` bigint auto_increment key, \
                                            `ats_remote_id` varchar(100), \
                                            `gt_candidate_id` bigint, \
                                            `added_at` timestamp not null, \
                                            `updated_at` timestamp not null \
                                           )")
        )

if ATSCandidateProfile.__tablename__ not in db.engine.table_names():
    db.session.execute(
        text("create table `ats_candidate_profile` ( \
                                                    `id` bigint auto_increment key, \
                                                    `active` BOOLEAN, \
                                                    `profile_json` text not null, \
                                                    `ats_id` bigint, \
                                                    `added_at` timestamp not null, \
                                                    `updated_at` timestamp not null \
                                                   )")
        )

if 'ats_enabled' not in User.__table__.columns.keys():
    db.session.execute(text("alter table user add column ats_enabled boolean"))
